<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible"
        content="ie=edge">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.4.2/css/bulma.min.css">
  <title>Document</title>
</head>

<body>
  <section class="hero is-info is-small">
    <div class="hero-body">
      <div class="container">
        <h1 class="title">
          Firefox 新同文堂
        </h1>
        <h2 class="subtitle">
          過濾網址與轉換詞彙設定檔舊轉新
        </h2>
      </div>
    </div>
  </section>
  <section class="section hero is-light">
    <div class="container">
      <h1 class="title">請務必提供才能合併</h1>
      <div class="notification is-danger">
        <p>設定檔取得方式：</p>
        <ul>
          <li>Firefox</li>
          <ul>
            <li>套件直接匯出設定檔（v1.4+）</li>
          </ul>
          <li>Chrome</li>
          <ul>
            <li>套件直接匯出設定檔</li>
          </ul>
        </ul>
      </div>
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Firefox 現有新版設定檔</label>
            <p class="control">
              <textarea id="rawFirefox"
                        class="textarea"></textarea>
            </p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Chrome 現有新版設定檔</label>
            <p class="control">
              <textarea id="rawChrome"
                        class="textarea"></textarea>
            </p>
          </div>
        </div>
      </div>
      <div class="columns">
        <div class="column">
          <h1 class="title">過濾網址</h1>
          <div class="content">
            <div class="field">
              <label class="label">請貼上過濾網址設定</label>
              <p class="control">
                <textarea id="rawFilter"
                          class="textarea"
                          rows="30"
                          placeholder="tongwen_filter.txt 全選複製貼上"></textarea>
              </p>
            </div>
          </div>
        </div>
        <div class="column">
          <h1 class="title">轉換詞彙</h1>
          <div class="content">
            <div class="field">
              <label class="label">請貼上轉換詞彙設定</label>
              <p class="control">
                <textarea id="rawPhases"
                          class="textarea"
                          placeholder="tongwen.xml 全選複製貼上"></textarea>
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="columns">
        <div class="column">
          <button class="button is-fullwidth is-warning"
                  onclick="combineFirefox()">產生合併後的 Firefox 設定檔</button>
          <div class="field">
            <label class="label">合併後新 Firefox 設定檔</label>
            <p class="control">
              <textarea id="newFirefox"
                        class="textarea"
                        placeholder=""></textarea>
            </p>
          </div>
          <div class="notification is-danger">
            <p>Firefox：透過套件匯入新的設定檔</p>
          </div>
        </div>
        <div class="column">
          <button class="button is-fullwidth is-warning"
                  onclick="combineChrome()">產生合併後的 Chrome 設定檔</button>
          <div class="field">
            <label class="label">合併後新 Chrome 設定檔</label>
            <p class="control">
              <textarea id="newChrome"
                        class="textarea"
                        placeholder=""></textarea>
            </p>
          </div>
          <div class="notification is-danger">
            <p>Chrome：透過套件匯入新的設定檔</p>
          </div>
        </div>
      </div>
    </div>
  </section>
  <footer class="footer">
    <div class="container">
      <nav class="level">
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">github</p>
            <p class="title"><a href="https://github.com/t7yang/new-tongwentang-config-converter">t7yang</a></p>
          </div>
        </div>
      </nav>
    </div>
  </footer>
</body>
<script async
        defer
        src="https://buttons.github.io/buttons.js"></script>
<script>
  const newFirefox = document.querySelector('#newFirefox');
  const newChrome = document.querySelector('#newChrome');

  function convertFilter(rawFilter, isChrome) {
    const rawConfig = rawFilter.split('\n');
    const newConfig = rawConfig
      .filter(raw => raw.length > 0)
      .map(raw => {
        const [url, action] = raw.split('	');

        if (isChrome) {
          return { url, zhflag: action || 'none' };
        }
        else {
          return {
            url, action: (() => {
              switch (action) {
                case 'trad':
                  return 2;
                case 'simp':
                  return 3;
                default:
                  return 0;
              }
            })()
          };
        }
      });

    return newConfig;

  }

  function convertPhases(rawPhases) {
    const rawSimplified = rawPhases.split('\n').reduce((curr, next) => {
      if (next.trim() === '</simplified>') {
        curr.start = false;
        return curr;
      }

      if (next.trim() === '<simplified>') {
        curr.start = true;
        return curr;
      }

      if (curr.start) {
        curr.content.push(next.trim());
        return curr;
      }

      return curr;
    }, { start: false, end: false, content: [] });

    const simplified = rawSimplified.content.map(item => {
      const target = item.match(/<s>(.+)<\/s>/)[1];
      const result = item.match(/<r>(.+)<\/r>/)[1];

      return { [target]: result };
    }).reduce((curr, next) => {
      return Object.assign(curr, next);
    }, {});

    const rawTraditional = rawPhases.split('\n').reduce((curr, next) => {
      if (next.trim() === '</traditional>') {
        curr.start = false;
        return curr;
      }

      if (next.trim() === '<traditional>') {
        curr.start = true;
        return curr;
      }

      if (curr.start) {
        curr.content.push(next.trim());
        return curr;
      }

      return curr;
    }, { start: false, end: false, content: [] });

    const traditional = rawTraditional.content.map(item => {
      const target = item.match(/<s>(.+)<\/s>/)[1];
      const result = item.match(/<r>(.+)<\/r>/)[1];

      return { [target]: result };
    }).reduce((curr, next) => {
      return Object.assign(curr, next);
    }, {});

    return { simplified, traditional };
  }

  function combineFirefox() {
    const rawFirefox = JSON.parse(document.querySelector('#rawFirefox').value);
    const rawFilter = document.querySelector('#rawFilter').value;
    const rawPhases = document.querySelector('#rawPhases').value;

    const newFilter = convertFilter(rawFilter, false);
    rawFirefox.urlFilterList = [...rawFirefox.urlFilterList, ...newFilter];

    const newPhases = convertPhases(rawPhases);
    rawFirefox.userPhraseSimpList = Object.assign({}, rawFirefox.userPhraseSimpList, newPhases.simplified);
    rawFirefox.userPhraseTradList = Object.assign({}, rawFirefox.userPhraseSimpList, newPhases.traditional);

    newFirefox.innerHTML = JSON.stringify(rawFirefox, null, 2);
  }

  function combineChrome() {
    const rawChrome = JSON.parse(document.querySelector('#rawChrome').value);
    const rawFilter = document.querySelector('#rawFilter').value;
    const rawPhases = document.querySelector('#rawPhases').value;
    console.log(rawPhases);

    const newFilter = convertFilter(rawFilter, true);
    rawChrome.urlFilter.list = [...rawChrome.urlFilter.list, ...newFilter];

    const newPhases = convertPhases(rawPhases);
    rawChrome.userPhrase.simp = Object.assign({}, rawChrome.userPhrase.simp, newPhases.simplified);
    rawChrome.userPhrase.trad = Object.assign({}, rawChrome.userPhrase.trad, newPhases.traditional);

    newChrome.innerHTML = JSON.stringify(rawChrome, null, 2);
  }

</script>

</html>